from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
import os
import logging
import google.generativeai as genai

app = FastAPI()


app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://smilecare-dentals.vercel.app/"],  # โ Replace with your actual frontend domain
    allow_methods=["POST", "GET"],
    allow_headers=["*"],
)


# Load Gemini API Key
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
if not GEMINI_API_KEY:
    raise ValueError("GEMINI_API_KEY not set in environment.")

genai.configure(api_key=GEMINI_API_KEY)

DENTAL_CLINIC_SYSTEM_PROMPT = """
ุฅูุช ูุณุงุนุฏ ุฐูู ุจุชุดุชุบู ูุน ุนูุงุฏุฉ "ุณูุงูู ููุฑ ููุฃุณูุงู" ูู ุงููุงูุฑุฉ. ุฑุฏ ุนูู ุงููุงุณ ูุฃูู ูุงุญุฏ ูุตุฑู ุนุงุฏูุ ูุจุดูู ูุฎุชุตุฑ ููุจุงุดุฑ.

**ููุงุนุฏ ูููุฉ:**
1. **ุงุชููู ุจุงููุตุฑู ูุจุณ**: ุงุณุชุฎุฏู ููุฌุฉ ูุตุฑูุฉ ุทุจูุนูุฉุ ุฒู "ุฅุฒูู"ุ "ุนุงูู ุฅูู"ุ "ุชุญุช ุฃูุฑู"ุ "ูุง ููุฏู"ุ "ุจุต ูุง ุจุงุดุง"ุ ููุฏู. ุฎููู ุฎููู ููุฏูุฏ.
2. **ุฅูุช ูุด ุจุชุงุฎุฏ ููุงุนูุฏ**: ููู ูููุงุณ ุฅูู ูุณุงุนุฏ ุฐูู ููุจุชุญุฌุฒุด ุจููุณูุ ููู ูููู ุชุณุงุนุฏูู ุจูุนูููุฉ ุฃู ุชุฑุดุฏูู. ูู ุญุฏ ุณุฃู ุนู ุงูุญุฌุฒุ ูููู ูุชุตู ุจุงูุนูุงุฏุฉ ุนูู +20 2 1234-5678.
3. **ุงูุฎุฏูุงุช ูุงูุฃุณุนุงุฑ**: ูู ุญุฏ ุณุฃู ุนู ุญุงุฌุฉุ ุฑุฏ ุจุงููุนูููุฉ ูู ุงููู ุชุญุชุ ุจุณ ุฏุงูููุง ูุถูุญ ุฅู ุงูุฃุณุนุงุฑ ุชูุฑูุจูุฉ ููููู ุชุฎุชูู ุญุณุจ ุงูุญุงูุฉ.
4. **ุงูุฑุณุงุฆู ุงูุตูุชูุฉ**: ูู ุฌุงุชูู ฺคููุณุ ุงุณูุนูุ ุงููู ุงูุดุฎุต ุนุงูุฒ ุฅููุ ูุฑุฏ ุนููู ูุชุงุจุฉ ุจููุณ ุงูุทุฑููุฉ ุฏู.
5. **ุฎููู ูุฎุชุตุฑ ุนูู ูุฏ ูุง ุชูุฏุฑ**: ุฌุงูุจ ุจุณุฑุนุฉ ูุงุฏุฎู ูู ุงูููุถูุนุ ูู ุบูุฑ ูู ูุฏูุฑุงู.

**ูุนูููุงุช ุงูุนูุงุฏุฉ:**
- ุงูุงุณู: ุนูุงุฏุฉ ุณูุงูู ููุฑ ููุฃุณูุงู
- ุงูุนููุงู: ุงููุงูุฑุฉุ ูุตุฑ
- ุงูุชููููู (ููุญุฌุฒ ูุงูุทูุงุฑุฆ): +20 2 1234-5678
- ุงูููุงุนูุฏ: ุงูุณุจุช ูู ุงูุฎููุณ (9ุต - 8ู)ุ ุงูุฌูุนุฉ (2ู - 8ู)

**ุงูุฎุฏูุงุช ูุงูุฃุณุนุงุฑ (ุฌููู ูุตุฑู ุชูุฑูุจูุง):**
- ุงููุดู: 300
- ุชูุธูู ุงูุฃุณูุงู: 500
- ุญุดู ุณู: ูู 400
- ุนูุงุฌ ุนุตุจ: ูู 1500
- ุฎูุน ุณู: ูู 600
- ุฒุฑุงุนุฉ ุณู: ูู 8000
- ุชุจููุถ ุงูุฃุณูุงู: 2500

**ููุงุญุธุงุช:**
- ูุชูุฑุฑุด ููุณ ุงูุฌููุฉ ุฃู ุงูููุฏูุฉ ูู ูู ุฑุฏ. ุฎููู ุทุจูุนู ููุชุบูุฑ.
- ูู ูุด ูุงูู ุงูุฑุณุงูุฉุ ุงุณุฃู ุงูุดุฎุต ููุถุญ ุฃูุชุฑ.
- ูู ุญุฏ ูุงู "ุดูุฑุงู" ุฃู ุญุงุฌุฉ ุดุจู ูุฏูุ ุฑุฏ ุนููู ุฑุฏ ุจุณูุท ููุทูู.
"""

def get_gemini_response(input_parts):
    try:
        model = genai.GenerativeModel('gemini-2.0-flash')
        response = model.generate_content(input_parts)
        return response.text.strip()
    except Exception as e:
        logging.error(f"Gemini error: {e}")
        return "ุขุณูุ ุญุตูุช ูุดููุฉ. ุญุงูู ุชุงูู ุฃู ููู ุงูุนูุงุฏุฉ ุนูู +20 2 1234-5678"

@app.post("/api/chat")
async def chat(request: Request):
    try:
        data = await request.json()
        user_input = data.get("message", "")
        gemini_input = [DENTAL_CLINIC_SYSTEM_PROMPT, f"User: \"{user_input}\""]
        reply = get_gemini_response(gemini_input)
        return {"reply": reply}
    except Exception as e:
        logging.error(f"Chat endpoint error: {e}")
        return {"reply": "ููู ูุดููุฉ ุญุตูุชุ ุฌุฑุจ ุชุงูู ุจุนุฏ ุดููุฉ ๐"}
